<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Value Trade Table</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 10px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 10px;
            margin-bottom: 10px;
        }

        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        th, td {
            padding: 4px 6px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 9px;
        }

        tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        tbody tr:hover {
            background: #e9ecef;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #667eea;
            margin-right: 4px;
        }

        .item-text {
            display: inline-block;
            min-width: 150px;
            padding: 2px 4px;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: text;
            font-size: 9px;
        }

        .item-text:focus {
            outline: none;
            border-color: #667eea;
            background: #f0f7ff;
        }

        .points-input {
            width: 50px;
            padding: 2px 4px;
            border: 1px solid #ddd;
            border-radius: 3px;
            text-align: center;
            font-size: 9px;
            font-weight: 600;
            color: #667eea;
        }

        .points-input:focus {
            outline: none;
            border-color: #667eea;
            background: #f0f7ff;
        }

        .points-display {
            font-weight: 600;
            color: #667eea;
            text-align: center;
            display: inline-block;
            width: 50px;
        }

        .points {
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }

        .stage {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 8px;
            font-weight: 600;
            color: white;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .stage.discovery {
            background: #4CAF50;
        }

        .stage.qualification {
            background: #2196F3;
        }

        .stage.evaluation {
            background: #FF9800;
        }

        .stage.proposal {
            background: #9C27B0;
        }

        .stage.contract {
            background: #F44336;
        }

        .stage.closing {
            background: #00BCD4;
        }

        .summary {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .summary-label {
            font-weight: 600;
            color: #333;
        }

        .summary-value {
            font-weight: 700;
            color: #667eea;
        }

        .status {
            text-align: center;
            padding: 6px;
            background: #fff3cd;
            border-radius: 6px;
            font-weight: 600;
            color: #856404;
            margin-top: 8px;
            font-size: 10px;
        }

        .chart-container {
            background: white;
            padding: 10px;
            border-radius: 8px;
            height: 250px;
        }

        /* Modal/Popup Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #333;
            font-size: 18px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 12px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 200px;
            }
        }

        .edit-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .edit-section h2 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .table-name-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            background: white;
        }

        .table-name-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .points-edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 10px;
        }

        .point-edit-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .point-edit-item label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
        }

        .point-edit-item input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 10px;
            margin-bottom: 8px;
        }

        .point-edit-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 15px;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e9ecef;
            color: #333;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            table {
                font-size: 9px;
            }
            
            th, td {
                padding: 4px;
            }

            .points-edit-grid {
                grid-template-columns: 1fr;
            }

            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        .share-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .share-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .share-link-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .share-link-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .copy-btn.copied {
            background: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <a href="home.html" style="color: #667eea; text-decoration: none; font-size: 14px;">← Back to Home</a>
            <button class="btn" id="shareBtn" onclick="shareTable()" style="padding: 8px 16px; font-size: 12px;">Share Table</button>
        </div>
        <h1>High Value Trade Table</h1>
        
        <div class="tabs">
            <button class="tab active" data-tab="view">View Table</button>
            <button class="tab" data-tab="edit">Edit Items</button>
        </div>

        <div class="tab-content active" id="viewTab">
            <input type="text" class="table-name-input" id="tableName" placeholder="Enter table name..." value="High Value Trade Table">
        <div class="main-content">
            <div class="table-container">
                <table id="tradeTable">
                    <thead>
                        <tr>
                            <th>Customer Ask</th>
                            <th>Points</th>
                            <th>Your Ask</th>
                            <th>Points</th>
                            <th>Stage</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div>
                <div class="summary">
                    <div class="summary-row">
                        <span class="summary-label">Total Gives:</span>
                        <span class="summary-value" id="totalGives">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Gets:</span>
                        <span class="summary-value" id="totalGets">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Points Left (Gives):</span>
                        <span class="summary-value" id="pointsLeftGives">210</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Points Left (Gets):</span>
                        <span class="summary-value" id="pointsLeftGets">210</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Delta:</span>
                        <span class="summary-value" id="delta">0</span>
                    </div>
                    <div class="status" id="status">Balanced Opportunity</div>
                </div>

                <div class="chart-container">
                    <canvas id="pointsChart"></canvas>
                </div>
            </div>
        </div>
        </div>

        <div class="tab-content" id="editTab">
            <div class="edit-section">
                <h2>Edit All Items by Points (1-20)</h2>
                <div class="points-edit-grid" id="pointsEditGrid">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <div class="modal-header">
                <h2>Share Table</h2>
                <span class="close" id="closeShareModal">&times;</span>
            </div>
            <p style="margin: 15px 0; color: #666; font-size: 14px;">Share this link with others to let them view your table:</p>
            <div class="share-link-container">
                <input type="text" id="shareLinkInput" class="share-link-input" readonly>
                <button class="copy-btn" id="copyBtn" onclick="copyShareLink()">Copy Link</button>
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 12px;">Anyone with this link can view your table and see your changes in real-time.</p>
        </div>
    </div>

    <!-- Modal/Popup -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Checkbox Details</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label for="editCheckboxLabel">Checkbox Label:</label>
                    <input type="text" id="editCheckboxLabel" placeholder="e.g., Checkbox 1">
                </div>
                <button type="submit" class="btn">Save Checkbox Label</button>
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
            </form>
        </div>
    </div>

    <script>
        // Get table ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = urlParams.get('tableId');

        const API_URL = '/.netlify/functions';
        const isViewOnly = urlParams.get('view') === 'true';

        // Load table data from API or localStorage fallback
        async function loadTableData() {
            if (tableId) {
                try {
                    // Try to load from API first
                    const response = await fetch(`${API_URL}/get-table?tableId=${tableId}`);
                    if (response.ok) {
                        const table = await response.json();
                        setTimeout(() => {
                            const nameInput = document.getElementById('tableName');
                            if (nameInput) {
                                nameInput.value = table.name;
                            }
                        }, 0);
                        return table.data;
                    }
                } catch (error) {
                    console.error('Error loading from API:', error);
                }

                // Fallback to localStorage
                const tables = JSON.parse(localStorage.getItem('hvtTables') || '[]');
                const table = tables.find(t => t.id === tableId);
                if (table) {
                    setTimeout(() => {
                        const nameInput = document.getElementById('tableName');
                        if (nameInput) {
                            nameInput.value = table.name;
                        }
                    }, 0);
                    return table.data;
                }
            }
            // Default data if no table ID or table not found
            return [
            { order: 1, gives: { checked: true, text: 'Sales materials', points: 1 }, gets: { checked: false, text: 'Direct Contact Information – Full name, role/title, direct dial, and mobile number', points: 0 }, stage: 'Discovery' },
            { order: 2, gives: { checked: true, text: 'Case Study', points: 2 }, gets: { checked: false, text: 'Get Linkedin Connection', points: 0 }, stage: null },
            { order: 3, gives: { checked: true, text: 'NDA', points: 3 }, gets: { checked: false, text: 'NDA', points: 0 }, stage: null },
            { order: 4, gives: { checked: false, text: '"Ballpark" Pricing', points: 0 }, gets: { checked: false, text: 'Critical Business Issue Quantification ROI', points: 0 }, stage: 'Qualification' },
            { order: 5, gives: { checked: true, text: 'Competitive Comparison', points: 5 }, gets: { checked: false, text: 'Customer Goals and Obstacles', points: 0 }, stage: null },
            { order: 6, gives: { checked: false, text: 'Demo', points: 0 }, gets: { checked: false, text: 'Joint Evaluation Plan', points: 0 }, stage: null },
            { order: 7, gives: { checked: false, text: 'RoadMap', points: 0 }, gets: { checked: true, text: 'Budget/ Timelines/ Priorities Confirmed through discovery email', points: 7 }, stage: null },
            { order: 8, gives: { checked: true, text: 'Trial', points: 8 }, gets: { checked: false, text: 'Access to decision maker', points: 0 }, stage: null },
            { order: 9, gives: { checked: false, text: 'Extension of Trial', points: 0 }, gets: { checked: true, text: 'Committee members identified', points: 9 }, stage: null },
            { order: 10, gives: { checked: true, text: 'POC', points: 10 }, gets: { checked: true, text: 'Meet all committee members /stakeholders', points: 10 }, stage: 'Evaluation' },
            { order: 11, gives: { checked: false, text: 'Access to Executive Management', points: 0 }, gets: { checked: false, text: 'Buying Process and approval process documented', points: 0 }, stage: null },
            { order: 12, gives: { checked: false, text: 'Passes to Trade Show', points: 0 }, gets: { checked: false, text: 'Champion', points: 0 }, stage: 'Proposal' },
            { order: 13, gives: { checked: true, text: 'Legal discussion', points: 13 }, gets: { checked: false, text: 'Proposal Draft Submitted', points: 0 }, stage: null },
            { order: 14, gives: { checked: false, text: 'Redlines', points: 0 }, gets: { checked: false, text: 'Meeting to review and modify proposal', points: 0 }, stage: 'Contract' },
            { order: 15, gives: { checked: false, text: 'Payment Terms', points: 0 }, gets: { checked: false, text: 'Confirm purchase deadlines', points: 0 }, stage: 'Closing' },
            { order: 16, gives: { checked: false, text: 'References', points: 0 }, gets: { checked: false, text: 'Identify and meet legal contract', points: 0 }, stage: null },
            { order: 17, gives: { checked: false, text: 'Consulting', points: 0 }, gets: { checked: false, text: 'Redline Contract work confirmed with deadline', points: 0 }, stage: null },
            { order: 18, gives: { checked: false, text: 'Training /Onboarding', points: 0 }, gets: { checked: false, text: 'Implementation and Task Owners Documented', points: 0 }, stage: null },
            { order: 19, gives: { checked: false, text: 'Case Study', points: 0 }, gets: { checked: false, text: 'Signed Contract /PO', points: 0 }, stage: null },
            { order: 20, gives: { checked: false, text: 'Discount', points: 0 }, gets: { checked: false, text: 'Case study reference Agreed', points: 0 }, stage: null }
            ];
        }

        // Save table data to API or localStorage fallback
        async function saveTableData() {
            if (!tableId || isViewOnly) return; // Don't save in view-only mode
            
            const token = localStorage.getItem('authToken');
            const tableName = document.getElementById('tableName').value;

            if (token) {
                // Save to API
                try {
                    await fetch(`${API_URL}/save-table`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                        body: JSON.stringify({
                            tableId: tableId,
                            name: tableName,
                            data: tradeData,
                        }),
                    });
                    return;
                } catch (error) {
                    console.error('Error saving to API:', error);
                }
            }

            // Fallback to localStorage
            const tables = JSON.parse(localStorage.getItem('hvtTables') || '[]');
            const tableIndex = tables.findIndex(t => t.id === tableId);
            
            if (tableIndex !== -1) {
                tables[tableIndex].data = tradeData;
                tables[tableIndex].name = tableName;
                localStorage.setItem('hvtTables', JSON.stringify(tables));
            }
        }

        // Initialize data
        let tradeData = [];
        
        // Load data asynchronously
        (async () => {
            tradeData = await loadTableData();
            renderTable();
            renderEditSection();
        })();

        let currentEditRow = null;
        let currentEditType = null; // 'gives' or 'gets'
        let currentCheckboxNumber = null;
        let currentCheckboxElement = null;
        let chart = null;
        let checkboxCounter = 0;
        let checkboxLabels = {}; // Store custom labels for checkboxes

        // Auto-save functionality
        function autoSave() {
            saveTableData();
        }

        // Save on table name change
        document.getElementById('tableName').addEventListener('blur', autoSave);
        document.getElementById('tableName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.target.blur();
            }
        });

        // Initialize table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            checkboxCounter = 0;

            tradeData.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Get stage class for styling
                const stageClass = row.stage ? row.stage.toLowerCase().replace(/\s+/g, '-') : '';
                const stageDisplay = row.stage || '';
                
                // Preset points to order value (1-20) for display in view table - always show 1-20
                const givesPointsDisplay = row.order;
                const getsPointsDisplay = row.order;
                
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="checkbox" data-row="${index}" data-type="gives" data-checkbox-num="${++checkboxCounter}" ${row.gives.checked ? 'checked' : ''}>
                        <span class="item-text" data-row="${index}" data-type="gives">${row.gives.text}</span>
                    </td>
                    <td>
                        <span class="points-display">${givesPointsDisplay}</span>
                    </td>
                    <td>
                        <input type="checkbox" class="checkbox" data-row="${index}" data-type="gets" data-checkbox-num="${++checkboxCounter}" ${row.gets.checked ? 'checked' : ''}>
                        <span class="item-text" data-row="${index}" data-type="gets">${row.gets.text}</span>
                    </td>
                    <td>
                        <span class="points-display">${getsPointsDisplay}</span>
                    </td>
                    <td>
                        ${stageDisplay ? `<span class="stage ${stageClass}">${stageDisplay}</span>` : ''}
                    </td>
                `;
                
                tbody.appendChild(tr);
            });

            // Add event listeners to checkboxes
            document.querySelectorAll('.checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rowIndex = parseInt(e.target.dataset.row);
                    const type = e.target.dataset.type;
                    const checkboxNum = e.target.dataset.checkboxNum;
                    
                    // Toggle checkbox state
                    const row = tradeData[rowIndex];
                    row[type].checked = e.target.checked;
                    
                    // Update points - always show order value (1-20) in view table
                    if (e.target.checked && row[type].points === 0) {
                        row[type].points = row.order;
                    } else if (!e.target.checked) {
                        row[type].points = 0;
                    }
                    // Points display always shows order (1-20) in view table - it's read-only
                    const rowElement = e.target.closest('tr');
                    const pointsCell = type === 'gives' ? rowElement.children[1] : rowElement.children[3];
                    const pointsDisplay = pointsCell.querySelector('.points-display');
                    if (pointsDisplay) {
                        pointsDisplay.textContent = row.order; // Always show 1-20
                    }
                    
                    updateSummary();
                    updateChart();
                    
                    // Open popup only for right-hand side checkboxes (gets/Your Ask)
                    if (type === 'gets') {
                        openEditModal(rowIndex, type, checkboxNum);
                    }
                });
            });

            // No event listeners for text or points in view tab - everything is read-only

            updateSummary();
            updateChart();
        }


        function handleTextBlur(e) {
            const rowIndex = parseInt(e.target.dataset.row);
            const type = e.target.dataset.type;
            const newText = e.target.textContent.trim();
            
            if (tradeData[rowIndex] && tradeData[rowIndex][type]) {
                tradeData[rowIndex][type].text = newText;
                renderEditSection(); // Update edit section
                autoSave(); // Save changes
            }
        }

        function handlePointsChange(e) {
            const rowIndex = parseInt(e.target.dataset.row);
            const type = e.target.dataset.type;
            const newPoints = parseInt(e.target.value) || 0;
            
            if (tradeData[rowIndex] && tradeData[rowIndex][type]) {
                tradeData[rowIndex][type].points = newPoints;
                // Update checkbox if points are set
                if (newPoints > 0) {
                    tradeData[rowIndex][type].checked = true;
                    const rowElement = e.target.closest('tr');
                    const checkbox = type === 'gives'
                        ? rowElement.querySelector('.checkbox[data-type="gives"]')
                        : rowElement.querySelector('.checkbox[data-type="gets"]');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                } else {
                    tradeData[rowIndex][type].checked = false;
                    const rowElement = e.target.closest('tr');
                    const checkbox = type === 'gives'
                        ? rowElement.querySelector('.checkbox[data-type="gives"]')
                        : rowElement.querySelector('.checkbox[data-type="gets"]');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                }
            }
            
            updateSummary();
            updateChart();
            renderEditSection(); // Update edit section when points change
            autoSave(); // Save changes
        }


        function openEditModal(rowIndex, type, checkboxNum) {
            currentEditRow = rowIndex;
            currentEditType = type;
            currentCheckboxNumber = checkboxNum;
            
            // Get the checkbox element to store label
            const tbody = document.getElementById('tableBody');
            const rowElement = tbody.children[rowIndex];
            currentCheckboxElement = rowElement.querySelector(`.checkbox[data-checkbox-num="${checkboxNum}"]`);
            
            // Get or create checkbox label
            const checkboxKey = `checkbox_${checkboxNum}`;
            const defaultLabel = `Checkbox ${checkboxNum}`;
            const currentLabel = checkboxLabels[checkboxKey] || defaultLabel;
            
            // Set editable checkbox label
            document.getElementById('editCheckboxLabel').value = currentLabel;
            
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditRow = null;
            currentEditType = null;
            currentCheckboxNumber = null;
            currentCheckboxElement = null;
        }

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('cancelBtn').addEventListener('click', closeModal);

        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (currentCheckboxNumber !== null) {
                // Save the checkbox label
                const checkboxKey = `checkbox_${currentCheckboxNumber}`;
                const newLabel = document.getElementById('editCheckboxLabel').value.trim() || `Checkbox ${currentCheckboxNumber}`;
                checkboxLabels[checkboxKey] = newLabel;
                
                // The label is stored but not displayed in the table (since checkboxes don't show labels)
                // This is just for reference/storage purposes
                
                closeModal();
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('editModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        function updateSummary() {
            const totalGives = tradeData.reduce((sum, row) => sum + (row.gives.checked ? row.gives.points : 0), 0);
            const totalGets = tradeData.reduce((sum, row) => sum + (row.gets.checked ? row.gets.points : 0), 0);
            const maxPoints = 210;
            const pointsLeftGives = maxPoints - totalGives;
            const pointsLeftGets = maxPoints - totalGets;
            const delta = Math.abs(totalGives - totalGets);
            
            document.getElementById('totalGives').textContent = totalGives;
            document.getElementById('totalGets').textContent = totalGets;
            document.getElementById('pointsLeftGives').textContent = pointsLeftGives;
            document.getElementById('pointsLeftGets').textContent = pointsLeftGets;
            document.getElementById('delta').textContent = delta;
            
            const statusEl = document.getElementById('status');
            if (delta === 0) {
                statusEl.textContent = 'Balanced Opportunity';
                statusEl.style.background = '#d4edda';
                statusEl.style.color = '#155724';
            } else if (delta <= 10) {
                statusEl.textContent = 'Nearly Balanced Opportunity';
                statusEl.style.background = '#fff3cd';
                statusEl.style.color = '#856404';
            } else {
                statusEl.textContent = 'Unbalanced Opportunity';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
            }
        }

        function updateChart() {
            const totalGives = tradeData.reduce((sum, row) => sum + (row.gives.checked ? row.gives.points : 0), 0);
            const totalGets = tradeData.reduce((sum, row) => sum + (row.gets.checked ? row.gets.points : 0), 0);
            const maxPoints = 210;
            const pointsLeftGives = maxPoints - totalGives;
            const pointsLeftGets = maxPoints - totalGets;
            
            const ctx = document.getElementById('pointsChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Points Left (Gives)', 'Points Left (Gets)'],
                    datasets: [{
                        label: 'Points',
                        data: [pointsLeftGives, pointsLeftGets],
                        backgroundColor: [
                            '#f093fb',
                            '#4facfe'
                        ],
                        borderColor: [
                            '#d17ae8',
                            '#3d8fd6'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Points: ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: maxPoints,
                            ticks: {
                                stepSize: 20,
                                font: {
                                    size: 9
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 9
                                }
                            }
                        }
                    }
                }
            });
        }

        // Render edit section for points 1-20
        function renderEditSection() {
            const grid = document.getElementById('pointsEditGrid');
            grid.innerHTML = '';

            for (let point = 1; point <= 20; point++) {
                // Find items with this point value
                const givesItem = tradeData.find(row => row.gives.points === point);
                const getsItem = tradeData.find(row => row.gets.points === point);

                const itemDiv = document.createElement('div');
                itemDiv.className = 'point-edit-item';
                itemDiv.innerHTML = `
                    <label>Point ${point}:</label>
                    <input type="text" 
                           class="gives-text-edit" 
                           data-point="${point}" 
                           placeholder="Customer Ask (Gives)" 
                           value="${givesItem ? givesItem.gives.text : ''}">
                    <input type="text" 
                           class="gets-text-edit" 
                           data-point="${point}" 
                           placeholder="Your Ask (Gets)" 
                           value="${getsItem ? getsItem.gets.text : ''}">
                `;
                grid.appendChild(itemDiv);
            }

            // Add event listeners
            document.querySelectorAll('.gives-text-edit').forEach(input => {
                input.addEventListener('blur', handlePointTextEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });
            });

            document.querySelectorAll('.gets-text-edit').forEach(input => {
                input.addEventListener('blur', handlePointTextEdit);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });
            });
        }

        function handlePointTextEdit(e) {
            const point = parseInt(e.target.dataset.point);
            const isGives = e.target.classList.contains('gives-text-edit');
            const newText = e.target.value.trim();

            // Find the item with this point value
            const item = tradeData.find(row => 
                isGives ? row.gives.points === point : row.gets.points === point
            );

            if (item) {
                if (isGives) {
                    item.gives.text = newText;
                } else {
                    item.gets.text = newText;
                }
                // Update the table display (but don't re-render edit section to avoid losing focus)
                renderTable();
                autoSave(); // Save changes
            }
        }

        // Tab switching functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // Remove active class from all tabs and tab contents
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${targetTab}Tab`).classList.add('active');
            });
        });

        // Share table functionality
        function shareTable() {
            if (!tableId) {
                alert('Please save your table first by going back to home and creating it properly.');
                return;
            }
            
            // Generate shareable link
            const shareUrl = `${window.location.origin}${window.location.pathname}?tableId=${tableId}&view=true`;
            const shareLinkInput = document.getElementById('shareLinkInput');
            if (shareLinkInput) {
                shareLinkInput.value = shareUrl;
            }
            
            // Show the popup modal
            const shareModal = document.getElementById('shareModal');
            if (shareModal) {
                shareModal.style.display = 'block';
            }
        }

        function copyShareLink() {
            const input = document.getElementById('shareLinkInput');
            if (!input) return;
            
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices
            
            // Use modern clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(input.value).then(() => {
                    showCopySuccess();
                });
            } else {
                // Fallback for older browsers
                document.execCommand('copy');
                showCopySuccess();
            }
        }

        function showCopySuccess() {
            const copyBtn = document.getElementById('copyBtn');
            if (!copyBtn) return;
            
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
        }

        // Close share modal
        document.getElementById('closeShareModal').addEventListener('click', () => {
            document.getElementById('shareModal').style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            const shareModal = document.getElementById('shareModal');
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
        });

        // Make everything read-only for shared view
        if (isViewOnly) {
            // Hide share button (can't share a shared link)
            const shareBtn = document.getElementById('shareBtn');
            if (shareBtn) shareBtn.style.display = 'none';
            
            // Hide edit tab for shared view
            const editTab = document.querySelector('.tab[data-tab="edit"]');
            if (editTab) editTab.style.display = 'none';
            
            // Make table name read-only
            const nameInput = document.getElementById('tableName');
            if (nameInput) {
                nameInput.readOnly = true;
                nameInput.style.background = '#f5f5f5';
                nameInput.style.cursor = 'not-allowed';
            }

            // Disable all checkboxes
            setTimeout(() => {
                document.querySelectorAll('.checkbox').forEach(cb => {
                    cb.disabled = true;
                    cb.style.cursor = 'not-allowed';
                });
            }, 100);
        }

        // Initialize on page load (data loaded asynchronously above)
    </script>
</body>
</html>

